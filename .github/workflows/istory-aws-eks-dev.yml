name: Istory Deploy to AWS EKS DEV

on:
  push:
    branches: [ "main", "test" ]

permissions:
  contents: write
  actions: read
  packages: write

jobs:
  build:
    if: contains(github.event.head_commit.message, '[deploy-dev]')
    runs-on: ubuntu-latest
    environment: k8s-dev

    env:
      DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/istory
      DOCKER_TAG: ${{ github.run_number }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      # AWS 인증
      - name: AWS CLI credentials 설정
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # kubectl
      - name: kubectl 설치
        run: |
          curl -LO https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: kubeconfig 업데이트
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.K8S_CLUSTER_NAME }}

      # kustomize
      - name: kustomize 설치
        run: |
          curl -s https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh | bash
          sudo mv kustomize /usr/local/bin

      # JDK
      - name: JDK 17 설치
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # 애플리케이션 코드 체크아웃
      - name: 소스 코드 체크아웃
        uses: actions/checkout@v4

      # application.yml 생성
      - name: application.yml 생성
        run: |
          cat > src/main/resources/application.yml << EOF
          spring:
            datasource:
              url: jdbc:mysql://localhost:3306/istory
              username: ${{ secrets.MYSQL_USER }}
              password: ${{ secrets.MYSQL_PASSWORD }}
              driver-class-name: com.mysql.cj.jdbc.Driver
            jpa:
              database-platform: org.hibernate.dialect.MySQL8Dialect
              hibernate:
                ddl-auto: update
              show-sql: true
            application:
              name: USER-SERVICE
          EOF

      # Gradle build
      - name: Gradle Build
        uses: gradle/gradle-build-action@v2

      - name: Java Build
        run: ./gradlew build -x test

      # Docker image
      - name: JAR 복사
        run: |
          mkdir -p xinfra/docker
          cp build/libs/*.jar xinfra/docker/

      - name: Docker 이미지 빌드
        run: |
          docker build xinfra/docker \
            -t ${{ secrets.DOCKER_USERNAME }}/istory:${{ env.DOCKER_TAG }} \
            -f xinfra/docker/Dockerfile
          docker tag ${{ secrets.DOCKER_USERNAME }}/istory:${{ env.DOCKER_TAG }} \
                     ${{ secrets.DOCKER_USERNAME }}/istory:latest

      - name: Docker Hub 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Docker Hub Push
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/istory:${{ env.DOCKER_TAG }}
          docker push ${{ secrets.DOCKER_USERNAME }}/istory:latest

      # 플랫폼 리포지토리 체크아웃
      - name: Platform Repo 체크아웃
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.GIT_USERNAME }}/${{ secrets.GIT_PLATFORM_REPO_NAME }}
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
          path: platform

      # K8s Secret
      - name: Kubernetes Secret 생성
        run: |
          kubectl create secret generic istory-db-secret \
            --from-literal=MYSQL_USER=${{ secrets.MYSQL_USER }} \
            --from-literal=MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }} \
            --from-literal=MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }} \
            --namespace=${{ secrets.K8S_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      # kustomize image tag 수정
      - name: kustomize 이미지 태그 수정
        run: |
          cd platform/overlay/aws-dev
          kustomize edit set image \
            ${{ secrets.DOCKER_USERNAME }}/istory=${{ secrets.DOCKER_USERNAME }}/istory:${{ env.DOCKER_TAG }}

      # Git commit & push
      - name: Platform Repo 업데이트
        run: |
          cd platform
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "[deploy-dev] update image tag ${{ env.DOCKER_TAG }}" || echo "no changes"
          git push origin main